#!/usr/bin/env bash
#
# agent - Unix-shaped tour advancing agent
#
# Usage:
#   ./agent "what dates are missing tech specs?"
#   cat state/emails/boston-tech.md | ./agent "extract relevant info"
#   echo "summarize what needs attention" | ./agent
#
# Configuration:
#   Set AGENT_BACKEND env var or create agent.conf with:
#     AGENT_BACKEND=claude-code   # uses Max subscription via Claude Code
#     AGENT_BACKEND=llm           # uses llm CLI (API costs)
#     AGENT_BACKEND=api           # uses direct Anthropic API (API costs)
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STATE_DIR="$SCRIPT_DIR/state"
SYSTEM_PROMPT="$SCRIPT_DIR/SYSTEM.md"
CONTEXT_FILE="$STATE_DIR/context.md"
CONFIG_FILE="$SCRIPT_DIR/agent.conf"

# Load config file if it exists (can be overridden by env vars)
if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$CONFIG_FILE"
fi

# --- Helpers ---

die() {
    echo "error: $1" >&2
    exit 1
}

# Check if stdin has data (non-blocking)
has_stdin() {
    [[ -t 0 ]] && return 1 || return 0
}

# Build inventory of state files
build_inventory() {
    echo "## Available State Files"
    echo ""

    if [[ -d "$STATE_DIR/dates" ]] && [[ -n "$(ls -A "$STATE_DIR/dates" 2>/dev/null)" ]]; then
        echo "### Dates"
        for f in "$STATE_DIR/dates"/*.md; do
            [[ -e "$f" ]] && echo "- $(basename "$f")"
        done
        echo ""
    fi

    if [[ -d "$STATE_DIR/venues" ]] && [[ -n "$(ls -A "$STATE_DIR/venues" 2>/dev/null)" ]]; then
        echo "### Venues"
        for f in "$STATE_DIR/venues"/*.md; do
            [[ -e "$f" ]] && echo "- $(basename "$f")"
        done
        echo ""
    fi

    if [[ -d "$STATE_DIR/emails" ]] && [[ -n "$(ls -A "$STATE_DIR/emails" 2>/dev/null)" ]]; then
        echo "### Emails"
        for f in "$STATE_DIR/emails"/*.md; do
            [[ -e "$f" ]] && echo "- $(basename "$f")"
        done
        echo ""
    fi

    if [[ -f "$STATE_DIR/TODO.md" ]]; then
        echo "### Outstanding"
        echo "- TODO.md"
        echo ""
    fi
}

# Build the full prompt for the LLM
build_prompt() {
    local task="$1"
    local stdin_content="$2"

    # System prompt
    cat "$SYSTEM_PROMPT"
    echo ""
    echo "---"
    echo ""

    # Current context (working memory)
    if [[ -f "$CONTEXT_FILE" ]]; then
        echo "## Current Context"
        echo ""
        cat "$CONTEXT_FILE"
        echo ""
        echo "---"
        echo ""
    fi

    # File inventory
    build_inventory
    echo "---"
    echo ""

    # Stdin content if provided
    if [[ -n "$stdin_content" ]]; then
        echo "## Input Document"
        echo ""
        echo "$stdin_content"
        echo ""
        echo "---"
        echo ""
    fi

    # The task
    echo "## Task"
    echo ""
    echo "$task"
}

# Call using Claude Code CLI (uses Max subscription)
call_claude_code() {
    local prompt="$1"

    if ! command -v claude &>/dev/null; then
        die "claude CLI not found. Install Claude Code: https://claude.ai/code"
    fi

    # Use print mode (-p) for non-interactive single-prompt usage
    # --tools "" disables all tools so CC acts as pure LLM (no file access, no bash)
    # --output-format text gives clean output without metadata
    echo "$prompt" | claude -p --tools "" --output-format text
}

# Call using llm CLI (llm.datasette.io)
call_llm_cli() {
    local prompt="$1"

    if ! command -v llm &>/dev/null; then
        die "llm CLI not found. Install: pip install llm"
    fi

    echo "$prompt" | llm -m "${LLM_MODEL:-claude-3.5-sonnet}"
}

# Call using curl to Anthropic API
call_anthropic_api() {
    local prompt="$1"

    if [[ -z "${ANTHROPIC_API_KEY:-}" ]]; then
        die "ANTHROPIC_API_KEY not set"
    fi

    local response
    response=$(curl -s https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "$(jq -n \
            --arg prompt "$prompt" \
            '{
                model: "claude-sonnet-4-20250514",
                max_tokens: 4096,
                messages: [{role: "user", content: $prompt}]
            }')")

    echo "$response" | jq -r '.content[0].text // .error.message // "Unknown error"'
}

# Main LLM call - routes based on AGENT_BACKEND config
call_llm() {
    local prompt="$1"
    local backend="${AGENT_BACKEND:-auto}"

    case "$backend" in
        claude-code|cc)
            call_claude_code "$prompt"
            ;;
        llm)
            call_llm_cli "$prompt"
            ;;
        api)
            call_anthropic_api "$prompt"
            ;;
        auto)
            # Auto-detect: prefer claude-code, then llm, then api
            if command -v claude &>/dev/null; then
                call_claude_code "$prompt"
            elif command -v llm &>/dev/null; then
                call_llm_cli "$prompt"
            elif [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
                call_anthropic_api "$prompt"
            else
                die "No backend available. Set AGENT_BACKEND or install claude/llm CLI"
            fi
            ;;
        *)
            die "Unknown AGENT_BACKEND: $backend (use: claude-code, llm, api, or auto)"
            ;;
    esac
}

# --- Main ---

main() {
    # Get task from argument or stdin
    local task=""
    local stdin_content=""

    if has_stdin; then
        stdin_content="$(cat)"
    fi

    if [[ $# -gt 0 ]]; then
        task="$*"
    elif [[ -n "$stdin_content" ]] && [[ -z "$task" ]]; then
        # If only stdin provided, treat last line as task or use default
        task="Process this input and update relevant state files."
    fi

    if [[ -z "$task" ]]; then
        die "Usage: ./agent \"task\" or command | ./agent \"task\""
    fi

    # Verify structure exists
    [[ -f "$SYSTEM_PROMPT" ]] || die "SYSTEM.md not found"
    [[ -d "$STATE_DIR" ]] || die "state/ directory not found"

    # Build and send prompt
    local prompt
    prompt="$(build_prompt "$task" "$stdin_content")"

    call_llm "$prompt"
}

main "$@"
