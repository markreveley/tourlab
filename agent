#!/usr/bin/env bash
#
# agent - Tour advancing agent (wrapper around agen)
#
# This is a domain-specific wrapper that builds tour context and calls agen.
# The context construction is pure shell (deterministic, no LLM).
# The LLM only gets called at the end via agen.
#
# Usage:
#   ./agent "what dates are missing tech specs?"
#   cat state/emails/boston-tech.md | ./agent "extract relevant info"
#
# Environment:
#   STATE_DIR - Path to state directory (default: ./state)
#               Example: STATE_DIR=~/tours/my-tour/state ./agent "query"
#
# Requires: agen in PATH (https://github.com/markreveley/agen)
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STATE_DIR="${STATE_DIR:-$SCRIPT_DIR/state}"
SYSTEM_FILE="$SCRIPT_DIR/SYSTEM.md"

die() {
  echo "agent: $*" >&2
  exit 1
}

# Check dependencies
command -v agen &>/dev/null || die "agen not found in PATH. Install from https://github.com/markreveley/agen"
[[ -f "$SYSTEM_FILE" ]] || die "SYSTEM.md not found"
[[ -d "$STATE_DIR" ]] || die "state/ directory not found. Set STATE_DIR to your tour state directory."

# Build file inventory (pure shell, no LLM)
build_inventory() {
  echo "## Available State Files"
  echo ""

  if [[ -d "$STATE_DIR/dates" ]] && compgen -G "$STATE_DIR/dates/*.md" > /dev/null 2>&1; then
    echo "### Dates"
    for f in "$STATE_DIR/dates"/*.md; do
      echo "- $(basename "$f")"
    done
    echo ""
  fi

  if [[ -d "$STATE_DIR/venues" ]] && compgen -G "$STATE_DIR/venues/*.md" > /dev/null 2>&1; then
    echo "### Venues"
    for f in "$STATE_DIR/venues"/*.md; do
      echo "- $(basename "$f")"
    done
    echo ""
  fi

  if [[ -d "$STATE_DIR/emails" ]] && compgen -G "$STATE_DIR/emails/*.md" > /dev/null 2>&1; then
    echo "### Emails"
    for f in "$STATE_DIR/emails"/*.md; do
      echo "- $(basename "$f")"
    done
    echo ""
  fi

  if [[ -f "$STATE_DIR/TODO.md" ]]; then
    echo "### Outstanding"
    echo "- TODO.md"
    echo ""
  fi
}

# Build combined context (pure shell, no LLM)
build_context() {
  # Layer 1: System prompt (identity + rules)
  cat "$SYSTEM_FILE"
  echo ""
  echo "---"
  echo ""

  # Layer 2: Working memory
  if [[ -f "$STATE_DIR/context.md" ]]; then
    echo "## Current Context"
    echo ""
    cat "$STATE_DIR/context.md"
    echo ""
    echo "---"
    echo ""
  fi

  # Layer 3: File inventory
  build_inventory
}

# Create combined context file
context_file=$(mktemp)
trap 'rm -f "$context_file"' EXIT
build_context > "$context_file"

# Pass through to agen (this is where LLM gets called)
agen --system="$context_file" "$@"
